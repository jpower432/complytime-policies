{
  "$schema": "https://calm.finos.org/release/1.1/meta/calm.json",
  "$id": "https://patterns.complytime.org/complytime-deployment.pattern.json",
  "title": "ComplyTime Deployment Pattern",
  "description": "Pattern for ComplyTime deployments with OTEL Collector in agent mode (sidecar/daemonset). Validates required ComplyTime components and ensures they reference Gemara controls for implementation validation.",
  "type": "object",
  "properties": {
    "nodes": {
      "type": "array",
      "items": {
        "allOf": [
          {
            "$ref": "https://calm.finos.org/release/1.1/meta/core.json#/defs/node"
          },
          {
            "$ref": "https://standards.complytime.org/complytime-node-metadata.standard.json"
          },
          {
            "oneOf": [
              {
                "properties": {
                  "node-type": {
                    "const": "cli"
                  },
                  "unique-id": {
                    "pattern": ".*complyctl.*"
                  },
                  "name": {
                    "pattern": ".*complyctl.*"
                  }
                },
                "required": ["unique-id", "name", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "const": "service"
                  },
                  "unique-id": {
                    "pattern": ".*complyctl.*plugin.*|.*complytime.*plugin.*"
                  },
                  "name": {
                    "pattern": ".*[Pp]lugin.*"
                  }
                },
                "required": ["unique-id", "name", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "const": "library"
                  },
                  "unique-id": {
                    "pattern": ".*proofwatch.*"
                  },
                  "name": {
                    "pattern": ".*[Pp]roof[Ww]atch.*"
                  }
                },
                "required": ["unique-id", "name", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "enum": ["service", "load-balancer", "gateway"]
                  },
                  "unique-id": {
                    "pattern": ".*collector.*|.*load.*balancer.*|.*lb.*|.*gateway.*lb.*"
                  },
                  "metadata": {
                    "properties": {
                      "deployment_mode": {
                        "enum": ["agent", "gateway"]
                      }
                    }
                  },
                  "controls": {
                    "type": "object",
                    "description": "Collector should reference controls for secure telemetry processing",
                    "patternProperties": {
                      "^[a-zA-Z0-9-]+$": {
                        "type": "object",
                        "properties": {
                          "requirements": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "requirement-url": {
                                  "type": "string",
                                  "pattern": "^gemara://(policies|controls)/[a-zA-Z0-9-]+(/[a-zA-Z0-9.-]+)+/requirements/[a-zA-Z0-9.-]+$",
                                  "description": "Gemara URL to assessment requirement (e.g., 'gemara://policies/{policy-id}/controls/{control-id}/requirements/{requirement-id}')"
                                }
                              },
                              "required": ["requirement-url"]
                            }
                          }
                        },
                        "required": ["requirements"]
                      }
                    }
                  }
                },
                "required": ["unique-id", "node-type", "metadata"]
              },
              {
                "properties": {
                  "node-type": {
                    "const": "service"
                  },
                  "unique-id": {
                    "pattern": ".*truthbeam.*"
                  },
                  "name": {
                    "pattern": ".*[Tt]ruth[Bb]eam.*"
                  }
                },
                "required": ["unique-id", "name", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "const": "service"
                  },
                  "unique-id": {
                    "pattern": ".*compass.*"
                  },
                  "name": {
                    "pattern": ".*[Cc]ompass.*"
                  },
                  "controls": {
                    "type": "object",
                    "description": "Compass service must reference Gemara controls for policy distribution security",
                    "patternProperties": {
                      "^[a-zA-Z0-9-]+$": {
                        "type": "object",
                        "properties": {
                          "requirements": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "requirement-url": {
                                  "type": "string",
                                  "pattern": "^gemara://(policies|controls)/[a-zA-Z0-9-]+(/[a-zA-Z0-9.-]+)+/requirements/[a-zA-Z0-9.-]+$",
                                  "description": "Gemara URL to assessment requirement (e.g., 'gemara://policies/{policy-id}/controls/{control-id}/requirements/{requirement-id}')"
                                }
                              },
                              "required": ["requirement-url"]
                            },
                            "minItems": 1
                          }
                        },
                        "required": ["requirements"]
                      }
                    },
                    "minProperties": 1
                  }
                },
                "required": ["unique-id", "name", "node-type", "controls"]
              },
              {
                "properties": {
                  "node-type": {
                    "enum": ["database", "storage"]
                  },
                  "unique-id": {
                    "pattern": ".*evidence.*store.*|.*s3.*"
                  }
                },
                "required": ["unique-id", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "const": "service"
                  },
                  "unique-id": {
                    "pattern": ".*loki.*"
                  },
                  "name": {
                    "pattern": ".*[Ll]oki.*"
                  }
                },
                "required": ["unique-id", "name", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "const": "service"
                  },
                  "unique-id": {
                    "pattern": ".*grafana.*"
                  },
                  "name": {
                    "pattern": ".*[Gg]rafana.*"
                  }
                },
                "required": ["unique-id", "name", "node-type"]
              },
              {
                "properties": {
                  "node-type": {
                    "enum": ["service", "application"]
                  }
                }
              }
            ]
          }
        ]
      },
      "minItems": 1
    },
    "relationships": {
      "type": "array",
      "items": {
        "allOf": [
          {
            "$ref": "https://calm.finos.org/release/1.1/meta/core.json#/defs/relationship"
          },
          {
            "$ref": "https://standards.complytime.org/complytime-relationship-metadata.standard.json"
          },
          {
            "type": "object",
            "properties": {
              "relationship-type": {
                "properties": {
                  "composed-of": {
                    "description": "Collector must be composed-of TruthBeam processor component"
                  },
                  "connects": {
                    "description": "Relationships between ComplyTime components"
                  }
                }
              }
            }
          }
        ]
      },
      "minItems": 1
    }
  },
  "required": ["nodes", "relationships"]
}
